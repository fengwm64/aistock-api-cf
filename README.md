# AIStock API

A 股数据 API，基于 Cloudflare Workers 构建，提供股票基本信息、实时行情、盈利预测、热门人气榜等接口。

## 架构

```
src/
├── index.ts                        # 入口 & 路由分发
├── controllers/                    # 控制器层：参数校验、缓存逻辑、响应组装
│   ├── StockInfoController.ts      # 股票基本信息
│   ├── StockQuoteController.ts     # 实时行情
│   ├── StockRankController.ts      # 热门人气榜
│   └── ProfitForecastController.ts # 盈利预测
├── services/                       # 服务层：核心业务逻辑 & 外部数据源请求
│   ├── EmService.ts                # 东方财富 - 股票基本信息
│   ├── EmQuoteService.ts           # 东方财富 - 实时行情
│   ├── EmStockRankService.ts       # 东方财富 - 人气榜排名
│   ├── ThsService.ts               # 同花顺 - 盈利预测
│   └── CacheService.ts             # KV 缓存封装
└── utils/                          # 工具层
    ├── response.ts                 # 统一响应格式
    ├── validator.ts                # A 股代码校验
    ├── stock.ts                    # 股票市场/板块识别
    ├── datetime.ts                 # 日期时间格式化
    └── parser.ts                   # HTML 表格解析
```

### 分层设计

| 层级 | 职责 | 示例 |
|------|------|------|
| **路由层** (`index.ts`) | URL 匹配、参数提取、方法校验 | `GET /api/cn/stock/info/000001` |
| **控制器层** (`controllers/`) | 参数校验、缓存读写、响应组装 | 缓存命中返回 `success (cached)` |
| **服务层** (`services/`) | 外部 API 调用、数据转换 | 请求东方财富/同花顺接口 |
| **工具层** (`utils/`) | 通用函数，无业务逻辑 | 日期格式化、代码校验 |

### 技术栈

- **Runtime**: Cloudflare Workers
- **Language**: TypeScript
- **Cache**: Cloudflare Workers KV
- **HTML Parsing**: cheerio
- **Encoding**: TextDecoder (GBK)

---

## API 接口

所有接口仅支持 `GET` 请求，统一响应格式：

```json
{
  "code": 200,
  "message": "success",
  "data": { ... }
}
```

### 1. 股票基本信息

获取股票的市场、板块、总股本、流通股、行业、市值等基础数据。

- **URL**: `/api/cn/stock/info/:symbol`
- **缓存**: 14 天

**请求示例**:

```
GET /api/cn/stock/info/000001
```

**响应示例**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "来源": "东方财富 http://quote.eastmoney.com/concept/sz000001.html?from=classic",
    "更新时间": "2026-02-08 12:08:16",
    "市场": "sz",
    "板块": "深市主板",
    "股票代码": "000001",
    "股票简称": "平安银行",
    "总股本": 19405918198,
    "流通股": 19405600653,
    "行业": "银行",
    "总市值": 214435396087.9,
    "流通市值": 214431887215.65,
    "上市时间": 19910403
  }
}
```

---

### 2. 实时行情

获取股票实时行情数据，支持批量查询。提供三级接口，按数据粒度递增：

| 级别 | URL | 说明 |
|------|-----|------|
| 一级 | `/api/cn/stock/quotes/core?symbols=` | 核心行情（最新价、涨跌幅） |
| 二级 | `/api/cn/stock/quotes/activity?symbols=` | 盘口/活跃度（含成交量、换手率、内外盘等） |
| 三级 | `/api/cn/stock/quotes/fundamental?symbols=` | 估值/基本面（含市盈率、ROE、总市值等） |

- **参数**: `symbols` — 逗号分隔的股票代码，单次最多 50 只
- **缓存**: 无（实时数据）
- **单位说明**: 成交量/内盘/外盘原始单位为手，已统一转换为**股**（1手=100股）；更新时间已从 Unix 时间戳转换为可读格式

#### 2.1 核心行情（一级）

**请求示例**:

```
GET /api/cn/stock/quotes/core?symbols=000001,600519
```

**响应示例**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "来源": "东方财富",
    "股票数量": 2,
    "行情": [
      {
        "股票代码": "000001",
        "股票简称": "平安银行",
        "最新价": 11.05,
        "涨跌幅": 1.01,
        "更新时间": "2026-02-08 14:35:20"
      },
      {
        "股票代码": "600519",
        "股票简称": "贵州茅台",
        "最新价": 1501.00,
        "涨跌幅": 1.01,
        "更新时间": "2026-02-08 14:35:20"
      }
    ]
  }
}
```

**返回字段**:
- `股票代码`: 6位股票代码
- `股票简称`: 股票名称
- `最新价`: 当前价格
- `涨跌幅`: 涨跌幅百分比
- `更新时间`: 数据更新时间（格式: YYYY-MM-DD HH:mm:ss）

---

#### 2.2 盘口/活跃度（二级）

**请求示例**:

```
GET /api/cn/stock/quotes/activity?symbols=000001
```

**响应示例**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "来源": "东方财富",
    "股票数量": 1,
    "行情": [
      {
        "股票代码": "000001",
        "股票简称": "平安银行",
        "最新价": 11.05,
        "均价": 11.02,
        "涨跌幅": 1.01,
        "涨跌额": 0.11,
        "成交量": 152380000,
        "成交额": 1679318400,
        "换手率": 0.79,
        "量比": 1.05,
        "最高价": 11.15,
        "最低价": 10.95,
        "今开价": 10.98,
        "昨收价": 10.94,
        "涨停价": 12.03,
        "跌停价": 9.85,
        "外盘": 78560000,
        "内盘": 73820000,
        "更新时间": "2026-02-08 14:35:20"
      }
    ]
  }
}
```

**返回字段**:
- `股票代码`: 6位股票代码
- `股票简称`: 股票名称
- `最新价`: 当前价格
- `均价`: 当日均价
- `涨跌幅`: 涨跌幅百分比
- `涨跌额`: 涨跌金额
- `成交量`: 成交量（股）
- `成交额`: 成交金额（元）
- `换手率`: 换手率百分比
- `量比`: 量比
- `最高价`: 当日最高价
- `最低价`: 当日最低价
- `今开价`: 今日开盘价
- `昨收价`: 昨日收盘价
- `涨停价`: 涨停价
- `跌停价`: 跌停价
- `外盘`: 主动买入成交量（股）
- `内盘`: 主动卖出成交量（股）
- `更新时间`: 数据更新时间

---

#### 2.3 估值/基本面（三级）

**请求示例**:

```
GET /api/cn/stock/quotes/fundamental?symbols=000001
```

**响应示例**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "来源": "东方财富",
    "股票数量": 1,
    "行情": [
      {
        "股票代码": "000001",
        "股票简称": "平安银行",
        "季度收益": 0.95,
        "动态市盈率": 5.68,
        "每股净资产": 19.52,
        "市净率": 0.57,
        "总营收": 185692000000,
        "总营收-同比": 8.5,
        "净利润": 45230000000,
        "净利润-同比": 6.2,
        "毛利率": 45.8,
        "净利率": 24.3,
        "ROE": 8.95,
        "负债率": 92.5,
        "总股本": 19405918198,
        "流通股": 19405600653,
        "总市值": 214435396087.9,
        "流通市值": 214431887215.65,
        "每股未分配利润": 12.35,
        "更新时间": "2026-02-08 14:35:20"
      }
    ]
  }
}
```

**返回字段**:
- `股票代码`: 6位股票代码
- `股票简称`: 股票名称
- `季度收益`: 最近季度每股收益
- `动态市盈率`: 动态市盈率（PE TTM）
- `每股净资产`: 每股净资产
- `市净率`: 市净率（PB）
- `总营收`: 总营收（元）
- `总营收-同比`: 总营收同比增长率（%）
- `净利润`: 净利润（元）
- `净利润-同比`: 净利润同比增长率（%）
- `毛利率`: 毛利率（%）
- `净利率`: 净利率（%）
- `ROE`: 净资产收益率（%）
- `负债率`: 资产负债率（%）
- `总股本`: 总股本（股）
- `流通股`: 流通股本（股）
- `总市值`: 总市值（元）
- `流通市值`: 流通市值（元）
- `每股未分配利润`: 每股未分配利润
- `更新时间`: 数据更新时间
```

---

### 3. 盈利预测

获取机构对股票的盈利预测数据，包括每股收益、净利润预测及机构详表。

- **URL**: `/api/cn/stock/profit-forecast/:symbol`
- **缓存**: 7 天

**请求示例**:

```
GET /api/cn/stock/profit-forecast/600519
```

**响应示例**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "来源": "同花顺 https://basic.10jqka.com.cn/new/600519/worth.html",
    "股票代码": "600519",
    "更新时间": "2026-02-08 10:30:00",
    "预测年报每股收益": [
      { "年度": "2025", "预测平均值": "66.82", "预测最高值": "70.50", "预测最低值": "63.00" }
    ],
    "预测年报净利润": [
      { "年度": "2025", "预测平均值": "840.00亿", "预测最高值": "886.00亿", "预测最低值": "792.00亿" }
    ],
    "业绩预测详表_机构": [
      {
        "机构名称": "中信证券",
        "研究员": "张三",
        "预测年报每股收益": { "2024": "62.50", "2025": "68.00", "2026": "75.00" },
        "预测年报净利润": { "2024": "786亿", "2025": "855亿", "2026": "943亿" },
        "报告日期": "2026-01-15"
      }
    ]
  }
}
```

---

### 4. 热门人气榜

获取东方财富个股人气榜 Top 100。

- **URL**: `/api/cn/market/stockrank/`
- **缓存**: 10 分钟

**请求示例**:

```
GET /api/cn/market/stockrank/
```

**响应示例**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "来源": "东方财富 http://guba.eastmoney.com/rank/",
    "更新时间": "2026-02-08 14:00:00",
    "人气榜": [
      { "当前排名": 1, "股票代码": "000001" },
      { "当前排名": 2, "股票代码": "600519" },
      { "当前排名": 3, "股票代码": "300750" }
    ]
  }
}
```

---

## 错误响应

| code | 说明 |
|------|------|
| 400 | 参数错误（缺少 symbol 或格式不合法） |
| 404 | 接口不存在 |
| 405 | 请求方法不允许（仅支持 GET） |
| 500 | 服务端错误 |

**示例**:

```json
{
  "code": 400,
  "message": "Invalid symbol - A股代码必须是6位数字",
  "data": null
}
```

---

## 开发

```bash
# 安装依赖
npm install

# 本地开发
npx wrangler dev

# 类型检查
npx tsc --noEmit

# 部署
npm run deploy
```
